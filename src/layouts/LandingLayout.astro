---
import "../styles/theme.css";
import Navbar from "../components/common/Navbar.astro";
import Footer from "../components/common/Footer.astro";
import PerfBooster from "../components/common/PerfBooster.astro";
import SiteHeader from "../components/SiteHeader.astro";

interface LayoutProps {
  /** These should come from your SEO APIs only */
  title?: string;
  description?: string;
  canonical?: string;
}

const { title, description, canonical } = Astro.props as LayoutProps;

/**
 * Backend / API origin derived from env
 * Example:
 * PUBLIC_API_BASE_URL = "https://test.amrita-fashions.com/api"
 * => API_ORIGIN = "https://test.amrita-fashions.com"
 */
const RAW_API_BASE = import.meta.env.PUBLIC_API_BASE_URL as string | undefined;
let API_ORIGIN = "";

if (RAW_API_BASE) {
  try {
    API_ORIGIN = new URL(RAW_API_BASE).origin;
  } catch {
    API_ORIGIN = RAW_API_BASE.replace(/\/+$/, "");
  }
}

/** ✅ Build client-safe env on server, then inject as JSON */
const clientEnv = {
  PUBLIC_API_BASE_URL: import.meta.env.PUBLIC_API_BASE_URL ?? "",
  PUBLIC_API_KEY: import.meta.env.PUBLIC_API_KEY ?? "",
  PUBLIC_API_KEY_HEADER: import.meta.env.PUBLIC_API_KEY_HEADER ?? "x-api-key",
  PUBLIC_ADMIN_EMAIL: import.meta.env.PUBLIC_ADMIN_EMAIL ?? "",
  PUBLIC_ADMIN_EMAIL_HEADER:
    import.meta.env.PUBLIC_ADMIN_EMAIL_HEADER ?? "x-admin-email",
};
const clientEnvJson = JSON.stringify(clientEnv);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />

    {title && <title>{title}</title>}
    {description && <meta name="description" content={description} />}
    {canonical && <link rel="canonical" href={canonical} />}

    <link rel="icon" href="/favicon.svg" />

    {API_ORIGIN && (
      <>
        <link rel="dns-prefetch" href={API_ORIGIN} />
        <link rel="preconnect" href={API_ORIGIN} crossorigin />
      </>
    )}

    <link rel="dns-prefetch" href="https://res.cloudinary.com" />
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin />

    <meta name="color-scheme" content="light dark" />

    <slot name="head" />

    <!-- ✅ FIXED: inject env as JSON (no { } expressions inside script body) -->
    <script
      is:inline
      set:html={`window.env = Object.assign(window.env || {}, ${clientEnvJson});`}
    ></script>

    <link rel="modulepreload" href="/scripts/url-lock.mjs" />
    <script type="module" src="/scripts/url-lock.mjs"></script>
  </head>

  <body class="page">
    <!-- <Navbar /> -->
    <SiteHeader />
    <main id="main" class="container-fluid">
      <slot />
    </main>
    <Footer />
    <PerfBooster />

    <!-- Global smooth scroll handler for all anchor links -->
    <script is:inline>
      document.addEventListener("DOMContentLoaded", function () {
        document.addEventListener("click", function (e) {
          const target = e.target.closest("a");
          if (!target) return;

          const href = target.getAttribute("href");
          if (!href || !href.startsWith("#")) return;

          // Skip if already handled by site-header.js
          if (
            target.closest(".nav-links, .mobile-nav, .age-footer, .cta, .m-cta")
          )
            return;

          const targetId = href.slice(1);
          const targetElement = document.getElementById(targetId);

          if (targetElement) {
            e.preventDefault();

            const header = document.querySelector(".site-header");
            const headerHeight = header ? header.offsetHeight : 96;
            const offset = headerHeight + 40;

            const targetPosition =
              targetElement.getBoundingClientRect().top +
              window.pageYOffset -
              offset;

            window.scrollTo({
              top: targetPosition,
              behavior: "smooth",
            });

            history.pushState(null, "", href);
          }
        });
      });
    </script>
  </body>
</html>
