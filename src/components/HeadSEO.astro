---
/**
 * Prints ONLY extra SEO meta/link tags from:
 * - Page-level seo (from SEO APIs / product×location API)
 * - Global defaultSeo (from /api/defaultseo)
 *
 * It deliberately does NOT output:
 * - <title>
 * - <meta name="description">
 * - <link rel="canonical">
 * Those are handled by the main layout using API values passed as props.
 */

import { apiGet } from "../lib/api-client.ts";

interface Props {
  seo?: Record<string, any> | null;
  canonical?: string | undefined;
}

const { seo = null, canonical } = Astro.props as Props;

/* ========= Default SEO API ========= */

const API_BASE = import.meta.env.PUBLIC_API_BASE_URL;
const DEFAULT_SEO_API = `${API_BASE}/defaultseo`;

let defaultSeo: Record<string, any> | null = null;

try {
  console.log("[HeadSEO] Attempting to fetch default SEO from:", DEFAULT_SEO_API);
  const res = await fetch(DEFAULT_SEO_API, {
    headers: { accept: "application/json" },
  });

  console.log("[HeadSEO] Default SEO response status:", res.status);
  if (res.ok) {
    const json = await res.json();
    console.log("[HeadSEO] Default SEO response data:", json);

    if (Array.isArray(json) && json.length > 0) {
      defaultSeo = json[0];
    } else if (Array.isArray((json as any)?.data) && (json as any).data.length > 0) {
      defaultSeo = (json as any).data[0];
    } else {
      defaultSeo = json;
    }
    console.log("[HeadSEO] Processed defaultSeo:", defaultSeo);
  } else {
    console.error("[HeadSEO] Failed to fetch default SEO, status:", res.status);
  }
} catch (error) {
  console.error("[HeadSEO] Error fetching default SEO:", error);
  defaultSeo = null;
}

/* ========= Office Information API (for GA and Clarity IDs) ========= */

let officeInfo: Record<string, any> | null = null;

try {
  if (API_BASE) {
    console.log("[HeadSEO] Attempting to fetch office information");
    const response = await apiGet("officeinformation");
    console.log("[HeadSEO] Office info response status:", response.status);
    if (response.ok) {
      const json = await response.json();
      console.log("[HeadSEO] Office info response data:", json);
      officeInfo = Array.isArray((json as any)?.data) && (json as any).data.length > 0 ? (json as any).data[0] : null;
      console.log("[HeadSEO] Processed officeInfo:", officeInfo);
      console.log("[HeadSEO] officeInfo.gaId:", officeInfo?.gaId);
      console.log("[HeadSEO] officeInfo.gaid:", officeInfo?.gaid);
      console.log("[HeadSEO] officeInfo.clarityId:", officeInfo?.clarityId);
      console.log("[HeadSEO] officeInfo.clarityid:", officeInfo?.clarityid);
    } else {
      console.error("[HeadSEO] Failed to fetch office info, status:", response.status);
    }
  } else {
    console.warn("[HeadSEO] API_BASE is not defined");
  }
} catch (error) {
  console.error("[HeadSEO] Error fetching office info:", error);
  officeInfo = null;
}

/* ========= Helpers ========= */

const asText = (v: any) => {
  if (v === null || v === undefined) return "";
  const s = String(v).trim();
  return s;
};

const asNumber = (value: any) => {
  const n = Number(value);
  return Number.isFinite(n) ? n : undefined;
};

/**
 * Pick a value only from API sources:
 * 1) page-level seo object
 * 2) defaultSeo object
 *
 * No hard-coded strings are used.
 */
const pickSeo = (...keys: string[]) => {
  for (const key of keys) {
    const v = (seo as any)?.[key];
    if (v !== undefined && v !== null && String(v).trim() !== "") return v;
  }
  for (const key of keys) {
    const v = (defaultSeo as any)?.[key];
    if (v !== undefined && v !== null && String(v).trim() !== "") return v;
  }
  return undefined;
};

/* ========= Resolved meta values (APIs only) ========= */

const title = asText(pickSeo("title"));
const description = asText(pickSeo("description"));

const keywords = asText(pickSeo("keywords"));
const robots = asText(pickSeo("robots"));

const author = asText(pickSeo("author_name", "authorname"));

const siteName = asText(pickSeo("ogSiteName", "ogsitename"));
const ogType = asText(pickSeo("ogType", "ogtype"));
const ogLocale = asText(pickSeo("ogLocale", "oglocale"));

const themeColor = asText(pickSeo("themeColor", "themecolor"));
const fmtDetect = asText(pickSeo("formatDetection", "formatdetection"));

const gVerify = asText(pickSeo("googleSiteVerification", "googlesiteverification"));

const msValidate = asText(pickSeo("msValidate", "microsofttoken"));

const appleStatus = asText(pickSeo("appleStatusBarStyle", "applestatusbarstyle"));

const mobileCap = asText(pickSeo("mobileWebAppCapable", "mobilewebappcapable"));

/* Twitter */
const twitterCard = asText(pickSeo("twitterCard", "twittercard"));
const twitterSite = asText(pickSeo("twitterSite", "twittersite"));

/**
 * For Twitter title/description:
 * - Prefer dedicated twitterTitle/twitterDescription if present.
 * - If not, fall back to title/description that also came from APIs.
 */
const rawTwitterTitle = pickSeo("twitterTitle", "twittertitle");
const twitterTitle = asText(rawTwitterTitle ?? title);

const rawTwitterDesc = pickSeo("twitterDescription", "twitterdescription");
const twitterDesc = asText(rawTwitterDesc ?? description);

const twitterPlayer = asText(pickSeo("twitterPlayer", "twitterplayer"));

const tpW = asNumber(pickSeo("twitterPlayerWidth", "twitterplayerwidth"));
const tpH = asNumber(pickSeo("twitterPlayerHeight", "twitterplayerheight"));

/* OG video */
const ogVideoType = asText(pickSeo("ogVideoType", "ogvideotype"));
const ogVideoW = asNumber(pickSeo("ogVideoWidth", "ogvideowidth"));
const ogVideoH = asNumber(pickSeo("ogVideoHeight", "ogvideoheight"));

/* ✅ Analytics IDs (OFFICEINFO FIRST, then fallback to SEO/default) */
const gaCandidate =
  officeInfo?.gaId ||
  officeInfo?.gaid ||
  pickSeo("gaId", "gaid");

const clarityCandidate =
  officeInfo?.clarityId ||
  officeInfo?.clarityid ||
  pickSeo("clarityId", "clarityid");

const normalizeGaId = (v: any) => {
  const s = String(v ?? "").trim();
  return /^G-[A-Z0-9]+$/i.test(s) ? s : null;
};

const normalizeClarityId = (v: any) => {
  let s = String(v ?? "").trim();
  if (!s) return null;

  // if someone pasted full URL, keep only the tail
  s = s.replace(/^https?:\/\/(www\.)?clarity\.ms\/tag\//i, "");

  // remove wrong prefix like "clarity-xxxxx"
  s = s.replace(/^clarity[-_]/i, "");

  // keep only alphanumeric (clarity project id is simple)
  s = s.replace(/[^a-z0-9]/gi, "").toLowerCase();

  // your example: t6huzv7k5g (10 chars)
  return /^[a-z0-9]{8,20}$/.test(s) ? s : null;
};

const validGaId = normalizeGaId(gaCandidate);
const validClarityId = normalizeClarityId(clarityCandidate);
const isValidClarityFormat = !!validClarityId;

/* Debug (server-side logs) */
console.log("[HeadSEO] gaCandidate:", gaCandidate);
console.log("[HeadSEO] clarityCandidate:", clarityCandidate);
console.log("[HeadSEO] validGaId:", validGaId);
console.log("[HeadSEO] validClarityId:", validClarityId);

/**
 * URL for OG/Twitter:
 * - Use canonical prop if provided (this should come from API).
 * - If not provided, we do NOT invent a URL.
 */
const urlForMeta = canonical && canonical.trim().length ? canonical.trim() : "";
---

<!-- Title / description / canonical are handled by the main layout using API values -->

<!-- Basics -->
{keywords && <meta name="keywords" content={keywords} />}
{robots && <meta name="robots" content={robots} />}
{author && <meta name="author" content={author} />}
{themeColor && <meta name="theme-color" content={themeColor} />}
{fmtDetect && <meta name="format-detection" content={fmtDetect} />}
{gVerify && <meta name="google-site-verification" content={gVerify} />}
{msValidate && <meta name="msvalidate.01" content={msValidate} />}
{appleStatus && (
  <meta
    name="apple-mobile-web-app-status-bar-style"
    content={appleStatus}
  />
)}
{mobileCap && <meta name="mobile-web-app-capable" content={mobileCap} />}

<!-- Open Graph -->
{title && <meta property="og:title" content={title} />}
{description && <meta property="og:description" content={description} />}
{siteName && <meta property="og:site_name" content={siteName} />}
{ogType && <meta property="og:type" content={ogType} />}
{ogLocale && <meta property="og:locale" content={ogLocale} />}
{urlForMeta && <meta property="og:url" content={urlForMeta} />}

{ogVideoType && <meta property="og:video:type" content={ogVideoType} />}
{typeof ogVideoW === "number" && (
  <meta property="og:video:width" content={String(ogVideoW)} />
)}
{typeof ogVideoH === "number" && (
  <meta property="og:video:height" content={String(ogVideoH)} />
)}

<!-- Twitter -->
{twitterCard && <meta name="twitter:card" content={twitterCard} />}
{twitterSite && <meta name="twitter:site" content={twitterSite} />}
{twitterTitle && <meta name="twitter:title" content={twitterTitle} />}
{twitterDesc && <meta name="twitter:description" content={twitterDesc} />}
{twitterPlayer && <meta name="twitter:player" content={twitterPlayer} />}
{typeof tpW === "number" && (
  <meta name="twitter:player:width" content={String(tpW)} />
)}
{typeof tpH === "number" && (
  <meta name="twitter:player:height" content={String(tpH)} />
)}

{validGaId && (
  <>
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${validGaId}`}></script>
    <script
      is:inline
      set:html={
        "window.dataLayer = window.dataLayer || [];\n" +
        "function gtag(){dataLayer.push(arguments);}\n" +
        "gtag('js', new Date());\n" +
        "gtag('config', '" + validGaId + "');"
      }
    ></script>
  </>
)}

{validClarityId && isValidClarityFormat && (
  <script
    is:inline
    set:html={`(function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "${validClarityId}");`}
  ></script>
)}
