---
/**
 * HeadSEO.astro
 * Prints ONLY extra SEO meta/link tags from:
 * - Page-level seo (from SEO APIs / product×location API)
 * - Global defaultSeo (from /defaultseo)
 *
 * It deliberately does NOT output:
 * - <title>
 * - <meta name="description">
 * - <link rel="canonical">
 * Those are handled by the main layout using API values passed as props.
 */

import { apiGet } from "../lib/api-client.ts";

interface Props {
  seo?: Record<string, any> | null;
  canonical?: string | undefined;
}

const { seo = null, canonical } = Astro.props as Props;

/* ========= Helpers ========= */

const asText = (v: any) => {
  if (v === null || v === undefined) return "";
  return String(v).trim();
};

const asNumber = (value: any) => {
  const n = Number(value);
  return Number.isFinite(n) ? n : undefined;
};

/**
 * Pick a value only from API sources:
 * 1) page-level seo object
 * 2) defaultSeo object
 */
const pickSeo = (defaultSeo: any, ...keys: string[]) => {
  for (const key of keys) {
    const v = (seo as any)?.[key];
    if (v !== undefined && v !== null && String(v).trim() !== "") return v;
  }
  for (const key of keys) {
    const v = (defaultSeo as any)?.[key];
    if (v !== undefined && v !== null && String(v).trim() !== "") return v;
  }
  return undefined;
};

/* ========= Default SEO API (FIXED: uses apiGet => sends auth headers) ========= */

let defaultSeo: Record<string, any> | null = null;

try {
  const res = await apiGet("defaultseo", { cache: "no-store" });

  if (res.ok) {
    const json = await res.json();

    // Support common shapes:
    // 1) [ {...} ]
    // 2) { data: [ {...} ] }
    // 3) { data: {...} }
    // 4) { ... }
    if (Array.isArray(json) && json.length > 0) {
      defaultSeo = json[0];
    } else if (Array.isArray((json as any)?.data) && (json as any).data.length > 0) {
      defaultSeo = (json as any).data[0];
    } else if ((json as any)?.data && typeof (json as any).data === "object") {
      defaultSeo = (json as any).data;
    } else if (json && typeof json === "object") {
      defaultSeo = json;
    } else {
      defaultSeo = null;
    }
  } else {
    console.error("[HeadSEO] Failed to fetch default SEO, status:", res.status);
    defaultSeo = null;
  }
} catch (error) {
  console.error("[HeadSEO] Error fetching default SEO:", error);
  defaultSeo = null;
}

/* ========= Office Information API (for GA and Clarity IDs) ========= */

let officeInfo: Record<string, any> | null = null;

try {
  const response = await apiGet("officeinformation", { cache: "no-store" });

  if (response.ok) {
    const json = await response.json();

    // Support shapes:
    // 1) { data: [ {...} ] }
    // 2) [ {...} ]
    // 3) { ... }
    if (Array.isArray((json as any)?.data) && (json as any).data.length > 0) {
      officeInfo = (json as any).data[0];
    } else if (Array.isArray(json) && json.length > 0) {
      officeInfo = json[0];
    } else if (json && typeof json === "object") {
      officeInfo = json;
    } else {
      officeInfo = null;
    }
  } else {
    console.error("[HeadSEO] Failed to fetch office info, status:", response.status);
    officeInfo = null;
  }
} catch (error) {
  console.error("[HeadSEO] Error fetching office info:", error);
  officeInfo = null;
}

/* ========= Resolved meta values (APIs only) ========= */

const title = asText(pickSeo(defaultSeo, "title"));
const description = asText(pickSeo(defaultSeo, "description"));

const keywords = asText(pickSeo(defaultSeo, "keywords"));
const robots = asText(pickSeo(defaultSeo, "robots"));

const author = asText(pickSeo(defaultSeo, "author_name", "authorname"));

const siteName = asText(pickSeo(defaultSeo, "ogSiteName", "ogsitename"));
const ogType = asText(pickSeo(defaultSeo, "ogType", "ogtype"));
const ogLocale = asText(pickSeo(defaultSeo, "ogLocale", "oglocale"));

const themeColor = asText(pickSeo(defaultSeo, "themeColor", "themecolor"));
const fmtDetect = asText(pickSeo(defaultSeo, "formatDetection", "formatdetection"));

const gVerify = asText(
  pickSeo(defaultSeo, "googleSiteVerification", "googlesiteverification")
);

const msValidate = asText(pickSeo(defaultSeo, "msValidate", "microsofttoken"));

const appleStatus = asText(
  pickSeo(defaultSeo, "appleStatusBarStyle", "applestatusbarstyle")
);

const mobileCap = asText(
  pickSeo(defaultSeo, "mobileWebAppCapable", "mobilewebappcapable")
);

/* Twitter */
const twitterCard = asText(pickSeo(defaultSeo, "twitterCard", "twittercard"));
const twitterSite = asText(pickSeo(defaultSeo, "twitterSite", "twittersite"));

const rawTwitterTitle = pickSeo(defaultSeo, "twitterTitle", "twittertitle");
const twitterTitle = asText(rawTwitterTitle ?? title);

const rawTwitterDesc = pickSeo(defaultSeo, "twitterDescription", "twitterdescription");
const twitterDesc = asText(rawTwitterDesc ?? description);

const twitterPlayer = asText(pickSeo(defaultSeo, "twitterPlayer", "twitterplayer"));
const tpW = asNumber(pickSeo(defaultSeo, "twitterPlayerWidth", "twitterplayerwidth"));
const tpH = asNumber(pickSeo(defaultSeo, "twitterPlayerHeight", "twitterplayerheight"));

/* OG video */
const ogVideoType = asText(pickSeo(defaultSeo, "ogVideoType", "ogvideotype"));
const ogVideoW = asNumber(pickSeo(defaultSeo, "ogVideoWidth", "ogvideowidth"));
const ogVideoH = asNumber(pickSeo(defaultSeo, "ogVideoHeight", "ogvideoheight"));

/* ✅ Analytics IDs (OFFICEINFO FIRST, then fallback to SEO/default) */
const gaCandidate =
  (officeInfo as any)?.gaId ||
  (officeInfo as any)?.gaid ||
  pickSeo(defaultSeo, "gaId", "gaid");

const clarityCandidate =
  (officeInfo as any)?.clarityId ||
  (officeInfo as any)?.clarityid ||
  pickSeo(defaultSeo, "clarityId", "clarityid");

const normalizeGaId = (v: any) => {
  const s = String(v ?? "").trim();
  return /^G-[A-Z0-9]+$/i.test(s) ? s : null;
};

const normalizeClarityId = (v: any) => {
  let s = String(v ?? "").trim();
  if (!s) return null;

  s = s.replace(/^https?:\/\/(www\.)?clarity\.ms\/tag\//i, "");
  s = s.replace(/^clarity[-_]/i, "");
  s = s.replace(/[^a-z0-9]/gi, "").toLowerCase();

  return /^[a-z0-9]{8,20}$/.test(s) ? s : null;
};

const validGaId = normalizeGaId(gaCandidate);
const validClarityId = normalizeClarityId(clarityCandidate);

/**
 * URL for OG/Twitter:
 * - Use canonical prop if provided (should come from API).
 * - If not provided, do NOT invent a URL.
 */
const urlForMeta = canonical && canonical.trim().length ? canonical.trim() : "";
---

<!-- Title / description / canonical are handled by the main layout using API values -->

<!-- Basics -->
{keywords && <meta name="keywords" content={keywords} />}
{robots && <meta name="robots" content={robots} />}
{author && <meta name="author" content={author} />}
{themeColor && <meta name="theme-color" content={themeColor} />}
{fmtDetect && <meta name="format-detection" content={fmtDetect} />}
{gVerify && <meta name="google-site-verification" content={gVerify} />}
{msValidate && <meta name="msvalidate.01" content={msValidate} />}
{appleStatus && (
  <meta name="apple-mobile-web-app-status-bar-style" content={appleStatus} />
)}
{mobileCap && <meta name="mobile-web-app-capable" content={mobileCap} />}

<!-- Open Graph -->
{title && <meta property="og:title" content={title} />}
{description && <meta property="og:description" content={description} />}
{siteName && <meta property="og:site_name" content={siteName} />}
{ogType && <meta property="og:type" content={ogType} />}
{ogLocale && <meta property="og:locale" content={ogLocale} />}
{urlForMeta && <meta property="og:url" content={urlForMeta} />}

{ogVideoType && <meta property="og:video:type" content={ogVideoType} />}
{typeof ogVideoW === "number" && <meta property="og:video:width" content={String(ogVideoW)} />}
{typeof ogVideoH === "number" && <meta property="og:video:height" content={String(ogVideoH)} />}

<!-- Twitter -->
{twitterCard && <meta name="twitter:card" content={twitterCard} />}
{twitterSite && <meta name="twitter:site" content={twitterSite} />}
{twitterTitle && <meta name="twitter:title" content={twitterTitle} />}
{twitterDesc && <meta name="twitter:description" content={twitterDesc} />}
{twitterPlayer && <meta name="twitter:player" content={twitterPlayer} />}
{typeof tpW === "number" && <meta name="twitter:player:width" content={String(tpW)} />}
{typeof tpH === "number" && <meta name="twitter:player:height" content={String(tpH)} />}

<!-- Google Analytics -->
{validGaId && (
  <>
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${validGaId}`}></script>
    <script
      is:inline
      set:html={
        "window.dataLayer = window.dataLayer || [];\n" +
        "function gtag(){dataLayer.push(arguments);}\n" +
        "gtag('js', new Date());\n" +
        "gtag('config', '" + validGaId + "');"
      }
    ></script>
  </>
)}

<!-- Microsoft Clarity -->
{validClarityId && (
  <script
    is:inline
    set:html={`(function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "${validClarityId}");`}
  ></script>
)}
