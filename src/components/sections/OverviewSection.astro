---
/* Static-headed, slug-aware Overview (no CTA, hoverable stat cards) */
import { apiGet } from "../../lib/api-client";

export interface Props {
  currentSlug?: string | null;
  seoApi?: string;
  productApi?: string;
}

const { currentSlug = null, seoApi, productApi } = Astro.props;

/* ========= Endpoints (kept, even if apiGet uses base internally) ========= */
const RAW_BASE_ENV = import.meta.env.PUBLIC_API_BASE_URL;
const RAW_BASE =
  typeof RAW_BASE_ENV === "string" ? RAW_BASE_ENV.replace(/\/+$/, "") : "";

const SEO_URL = (seoApi || (RAW_BASE ? `${RAW_BASE}/seo` : "") || "").replace(
  /\/+$/,
  ""
);
const PRODUCT_URL = (
  productApi || (RAW_BASE ? `${RAW_BASE}/product` : "") || ""
).replace(/\/+$/, "");

if (!RAW_BASE) {
  console.warn(
    "[OverviewSection] PUBLIC_API_BASE_URL is missing – Overview will render with fallback content only."
  );
}

/* ================= Cloudinary responsive helpers =================
   ✅ Makes srcset REAL by generating different Cloudinary URLs per width
   ✅ If your stored URL already contains transforms, it rebuilds cleanly from /v123... onwards
   ✅ Uses c_limit to avoid ugly upscaling (remove c_limit if you WANT upscaling)
*/
const cloudParts = (url: string) => {
  if (!url) return null;
  if (!url.includes("res.cloudinary.com") || !url.includes("/upload/")) return null;

  const [before, after] = url.split("/upload/");

  // strip any existing transforms by cutting from version segment v123...
  const m = after.match(/v\d+\//);
  const rest = m ? after.slice(m.index) : after;

  return { before, rest };
};

const cloudUrl = (url: string, w: number) => {
  const p = cloudParts(url);
  if (!p) return url;

  // NOTE: keep c_limit to prevent upscaling beyond original.
  // If you want upscaling: remove `c_limit,`
  return `${p.before}/upload/f_auto,q_auto,c_limit,w_${w}/${p.rest}`;
};

const buildSrcSet = (url: string) => {
  const p = cloudParts(url);
  if (!p) return "";

  // pick sensible widths for your layout
  const widths = [240, 320, 480, 640, 768, 1024, 1280];
  return widths.map((w) => `${cloudUrl(url, w)} ${w}w`).join(", ");
};

// sizes must match your CSS:
// - <=1024px you set max-width:100% (so it behaves like full width)
// - >=1024px you float right with inline-size: clamp(320px, 36vw, 520px)
const IMAGE_SIZES = `
  (min-width: 1280px) 520px,
  (min-width: 1024px) 36vw,
  calc(100vw - 28px)
`.trim();

/* ================= Data fetch ================= */
async function fetchJson(endpoint: string) {
  try {
    if (!endpoint) return null;
    const response = await apiGet(endpoint);
    if (!response.ok) return null;
    return await response.json();
  } catch {
    return null;
  }
}

const [seoJson, prodJson] = await Promise.all([fetchJson("seo"), fetchJson("product")]);

/* ================= Process data ================= */
const seos: any[] = Array.isArray(seoJson?.data) ? seoJson.data : [];
const products: any[] =
  Array.isArray(prodJson?.data) ? prodJson.data :
  Array.isArray(prodJson?.data?.products) ? prodJson.data.products :
  Array.isArray(prodJson) ? prodJson : [];

const safe = (v: any) => (v == null ? "" : String(v));
const norm = (s: any) => safe(s).trim().toLowerCase();
const toId = (v: any) =>
  typeof v === "string"
    ? v.trim()
    : v && v._id
    ? String(v._id).trim()
    : "";

const pickHtml = (o: any) => {
  if (!o) return "";
  const candidates = [
    o.productlocationdescription1,
    o.productlocationdescription2,
    o.description_html,
    o.productdescription,
    o.description1,
    o.description2,
    o.description3,
  ];
  for (const x of candidates) {
    if (typeof x === "string" && x.trim()) return x.trim();
  }
  return "";
};

const cleanHtml = (s: string) => s.replace(/^\s*\.\s*$/gm, "");

/* ================= Pick SEO & product ================= */
function pickSeo() {
  if (!seos.length) return null;

  if (currentSlug) {
    const bySlug = seos.find((s) => norm(s?.slug) === norm(currentSlug));
    if (bySlug) return bySlug;
  }

  return seos.find((s) => s?.landingPageProduct) ?? seos[0] ?? null;
}
const seo = pickSeo();

function pickProduct() {
  if (!products.length) return null;

  const pid = toId(seo?.product);
  if (pid) {
    const byId = products.find((p) => toId(p?._id) === pid);
    if (byId) return byId;
  }

  if (seo?.slug) {
    const bySlug = products.find((p) => norm(p?.slug) === norm(seo.slug));
    if (bySlug) return bySlug;
  }

  return products.find((p) => p?.landingPageProduct) ?? products[0] ?? null;
}
const product = pickProduct();

/* ================= Static heading/tagline ================= */
const STATIC_HEADING = "Leading B2B Fabric Supplier Worldwide";
const STATIC_TAGLINE = "ISO 9001 Certified • 500+ Global Partners • Ships to 50+ Countries";

/* ================= Dynamic body + image ================= */
const p1 = cleanHtml(pickHtml(seo) || pickHtml(product) || "");
const p2 = cleanHtml(seo?.productlocationdescription2 || product?.productlocationdescription2 || "");

const image = product?.image2 || product?.image3 || product?.image1 || "";
const imageAlt = seo?.title || product?.name || "Fabric image";

// ✅ Real Cloudinary responsive src/srcset (falls back safely if not Cloudinary)
const imageSrc = image ? cloudUrl(image, 640) : "";
const imageSrcSet = image ? buildSrcSet(image) : "";
---

<section class="ov" id="aboutus">
  <div class="wrap">
    <header class="head">
      <h2 class="title">{STATIC_HEADING}</h2>
      <p class="tag">{STATIC_TAGLINE}</p>
      <i class="bar" aria-hidden="true"></i>
    </header>

    <div class="content">
      {image && (
        <figure class="media wrap-shape" aria-label="Product image">
          <img
            src={imageSrc}
            srcset={imageSrcSet}
            sizes={IMAGE_SIZES}
            alt={imageAlt}
            title={imageAlt}
            loading="lazy"
            decoding="async"
            width="1024"
            height="768"
          />
        </figure>
      )}

      <div class="copy">
        {p1 && <div class="txt" set:html={p1} />}
        {p2 && <div class="txt mt" set:html={p2} />}

        <div class="stats" role="list">
          <div class="stat" role="listitem" aria-label="ISO 9001 certified company">
            <span class="num">ISO</span>
            <span class="lbl">9001 Certified</span>
          </div>
          <div class="stat" role="listitem" aria-label="500 plus global partners">
            <span class="num">500+</span>
            <span class="lbl">Global Partners</span>
          </div>
          <div class="stat" role="listitem" aria-label="50 plus countries served">
            <span class="num">50+</span>
            <span class="lbl">Countries Served</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    :root{ --age-blue:#2C4C97; --age-gold:#D6A74B; --age-navy:#112338 }

    .ov{position:relative;background:#f8fafc;padding:3.25rem 0}
    @media(min-width:640px){.ov{padding:4.75rem 0}}
    .wrap{max-width:1180px;margin:0 auto;padding:0 14px}

    .head{text-align:center;margin-bottom:1.9rem}
    .title{
      margin:0 0 .6rem;
      line-height:1.15;
      font-weight:800;
      color:#0f172a;
      font-size:clamp(1.9rem,3.2vw,2.9rem)
    }
    .tag{
      margin:0 0 .9rem;
      color:#475569;
      font-size:clamp(.98rem,1.2vw,1.05rem);
      letter-spacing:.1px
    }
    .bar{
      display:block;
      width:110px;
      height:4px;
      margin:.25rem auto 0;
      background:linear-gradient(90deg,var(--age-blue),#10b981);
      border-radius:999px
    }

    .content{display:grid;gap:1.6rem}

    .media{
      position:relative;
      border-radius:22px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 10px 32px rgba(15,34,53,.12);
      margin: 0;
      width: 100%;
      max-width: clamp(17.5rem, 38vw, 32.5rem);
      aspect-ratio: 3 / 4;
      max-height: 72vh;
    }
    .media img{
      display:block;
      width:100%;
      height:100%;
      object-fit:contain;
    }

    @media (max-width: 1024px){
      .media{
        max-width: 100%;
        aspect-ratio: 16 / 10;
        max-height: 48vh;
      }
    }
    @media (max-width: 640px){
      .media{ max-width: 100%; }
    }

    .copy{position:relative}
    .txt{color:#334155;line-height:1.8;font-size:1.06rem}
    .txt :where(h1,h2,h3){
      margin:.25rem 0 .5rem;
      line-height:1.25;
      font-size:1.15rem;
      font-weight:700;
      color:#0f172a
    }
    .txt :where(p,ul,ol){margin:.55rem 0}
    .txt :where(ul){padding-left:1.1rem}
    .mt{margin-top:1rem}

    .stats{display:grid;gap:1rem;margin-top:1.5rem;}

    .stat{
      background:#f0f4f8;
      border:1px solid rgba(17,35,56,.10);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(15,34,53,.08);
      text-align:center;
      transition:
        transform .18s ease,
        box-shadow .25s ease,
        border-color .25s ease,
        background-color .25s ease;
      will-change:transform;
      padding:1.25rem 1rem;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }

    .num{
      display:block;
      font-weight:800;
      font-size:clamp(1.25rem,2.5vw,1.75rem);
      color:var(--age-blue);
      margin-bottom:0.25rem;
    }
    .lbl{
      display:block;
      color:#5b6b80;
      font-size:0.95rem;
      font-weight:600;
    }

    @media (hover:hover){
      .stat:hover{
        transform:translateY(-3px);
        box-shadow:0 14px 30px rgba(15,34,53,.16);
        border-color:rgba(44,76,151,.35);
        background:
          linear-gradient(0deg,#f0f4f8,#f0f4f8) padding-box,
          radial-gradient(100% 100% at 50% 0, rgba(44,76,151,.18), rgba(214,167,75,.16)) border-box;
      }
    }

    @media (max-width: 639px){
      .stats{grid-template-columns:1fr;}
      .stat{padding:1.1rem 0.75rem;border-radius:16px;}
      .num{font-size:1.4rem;}
      .lbl{font-size:0.9rem;}
    }

    @media (min-width: 640px){
      .stats{
        grid-template-columns:repeat(3,minmax(0,1fr));
        max-width:720px;
        margin-top:1.75rem;
        margin-inline:auto;
      }
      .stat{padding:1.25rem 1rem;}
      .num{font-size:1.5rem;}
      .lbl{font-size:0.95rem;}
    }

    @media (min-width: 1024px){
      .content{display:block}
      .wrap-shape{
        inline-size: clamp(320px, 36vw, 520px);
        aspect-ratio: 4 / 3;
        float: right;
        margin: .25rem 0 1rem 1.6rem;
        shape-outside: inset(0 round 24px);
        shape-margin: 14px;
        clip-path: inset(0 round 22px);
      }
      .copy:after{content:"";display:block;clear:both}
    }
  </style>
</section>
