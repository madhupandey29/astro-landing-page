---
// src/components/FAQSection.astro

/* Phone / WhatsApp config */
const RAW_PHONE = String(
  import.meta.env.PUBLIC_WHATSAPP_NUMBER || "919925155141"
);
const DIGITS = RAW_PHONE.replace(/[^\d]/g, "");
const telHref = DIGITS ? `tel:+${DIGITS}` : "tel:+919925155141";
const whatsappHref = DIGITS ? `https://wa.me/${DIGITS}` : "https://wa.me/919925155141";

/* ===== Debug toggle ===== */
const DEBUG =
  String(import.meta.env.PUBLIC_DEBUG_LOGS || "").toLowerCase() === "true" ||
  !!import.meta.env.DEV;

const dlog = (...args: any[]) => DEBUG && console.log("[FAQ]", ...args);
const dwarn = (...args: any[]) => DEBUG && console.warn("[FAQ]", ...args);
const derr = (...args: any[]) => console.error("[FAQ]", ...args);

/* ===== API URLs + headers ===== */
const API_BASE = String(import.meta.env.PUBLIC_API_BASE_URL || "").replace(/\/+$/, "");

const buildHeaders = () => {
  const headers: Record<string, string> = { Accept: "application/json" };

  const apiKey = import.meta.env.PUBLIC_API_KEY;
  const apiKeyHeader = import.meta.env.PUBLIC_API_KEY_HEADER || "x-api-key";

  const adminEmail = import.meta.env.PUBLIC_ADMIN_EMAIL;
  const adminEmailHeader = import.meta.env.PUBLIC_ADMIN_EMAIL_HEADER || "x-admin-email";

  if (apiKey) headers[apiKeyHeader] = apiKey;
  if (adminEmail) headers[adminEmailHeader] = adminEmail;

  return headers;
};

const FAQ_API_URL = API_BASE ? `${API_BASE}/faqa` : "";
const PRODUCT_FAQ_API_URL = API_BASE ? `${API_BASE}/productandlocation/astro/products` : "";

/* ===== Types ===== */
type FaqItem = {
  id: string;
  questionHtml: string;
  answerHtml: string;
  source?: "global" | "product" | "location";
};

/* ===== Helpers ===== */
const norm = (v: any) => String(v ?? "").trim().toLowerCase();

function cleanHtml(html: string): string {
  if (!html) return "";
  return html
    .replace(/<pre[^>]*>/gi, "<p>")
    .replace(/<\/pre>/gi, "</p>");
}

/** Safely read JSON; if not JSON, return { __rawText } for debugging */
async function readJsonOrText(res: Response) {
  const ct = (res.headers.get("content-type") || "").toLowerCase();
  if (ct.includes("application/json")) {
    try {
      return await res.json();
    } catch (e) {
      return { __jsonError: String(e) };
    }
  }
  const txt = await res.text().catch(() => "");
  return { __rawText: txt.slice(0, 300), __contentType: ct || "(none)" };
}

function safeHeadersDebug() {
  const apiKeyHeader = import.meta.env.PUBLIC_API_KEY_HEADER || "x-api-key";
  const adminEmailHeader = import.meta.env.PUBLIC_ADMIN_EMAIL_HEADER || "x-admin-email";

  return {
    API_BASE: API_BASE || "(missing)",
    hasApiKey: !!import.meta.env.PUBLIC_API_KEY,
    apiKeyHeader,
    hasAdminEmail: !!import.meta.env.PUBLIC_ADMIN_EMAIL,
    adminEmailHeader,
  };
}

/* ===== Current slug from URL ===== */
const pageUrl = new URL(Astro.request.url);
const path = pageUrl.pathname.replace(/^\/+|\/+$/g, "");
const segments = path ? path.split("/") : [];
const slugFromUrl = segments[0] || "";
const slugFromUrlNorm = norm(slugFromUrl);

dlog("Render URL:", pageUrl.pathname);
dlog("Slug from URL:", slugFromUrl || "(none)");
dlog("Env:", safeHeadersDebug());
dlog("FAQ_API_URL:", FAQ_API_URL || "(missing)");
dlog("PRODUCT_FAQ_API_URL:", PRODUCT_FAQ_API_URL || "(missing)");

/* ===== Global FAQs from /faqa ===== */
let globalFaqs: FaqItem[] = [];

if (!FAQ_API_URL) {
  dwarn("FAQ_API_URL missing (check PUBLIC_API_BASE_URL). Global FAQs will be empty.");
} else {
  try {
    const headers = buildHeaders();

    // do NOT print key values
    dlog("Fetching global FAQs…", {
      url: FAQ_API_URL,
      headersSent: Object.keys(headers),
    });

    const res = await fetch(FAQ_API_URL, { headers });

    dlog("Global FAQs response:", { status: res.status, ok: res.ok });

    const json = await readJsonOrText(res);

    if (!res.ok) {
      derr("Global FAQs fetch failed:", {
        status: res.status,
        bodyPreview: (json as any)?.__rawText,
        contentType: (json as any)?.__contentType,
        jsonError: (json as any)?.__jsonError,
      });
    } else {
      // Accept common shapes:
      // 1) { data: [...] }
      // 2) [...]
      // 3) { success:true, data:[...] }
      const data = Array.isArray((json as any)?.data)
        ? (json as any).data
        : Array.isArray(json)
        ? json
        : [];

      dlog("Global FAQs parsed rows:", data.length);

      globalFaqs = data.map((item: any, idx: number) => ({
        id: String(item?._id || `global-${idx}-${Math.random().toString(16).slice(2)}`),
        questionHtml: cleanHtml(String(item?.question || "")),
        answerHtml: cleanHtml(String(item?.answer || "")),
        source: "global",
      })).filter((x: FaqItem) => x.questionHtml.trim() && x.answerHtml.trim());

      dlog("Global FAQs final usable:", globalFaqs.length);
    }
  } catch (err) {
    derr("Global FAQs fetch exception:", err);
    globalFaqs = [];
  }
}

/* ===== Product + Location FAQs from productandlocation API ===== */
let combinedProductFaqs: FaqItem[] = [];

if (!PRODUCT_FAQ_API_URL) {
  dwarn("PRODUCT_FAQ_API_URL missing (check PUBLIC_API_BASE_URL). Product/location FAQs will be empty.");
} else {
  try {
    const headers = { ...buildHeaders(), "Cache-Control": "no-cache" };

    dlog("Fetching product/location FAQs…", {
      url: PRODUCT_FAQ_API_URL,
      headersSent: Object.keys(headers),
    });

    const res = await fetch(PRODUCT_FAQ_API_URL, { headers });

    dlog("Product/location response:", { status: res.status, ok: res.ok });

    const json = await readJsonOrText(res);

    if (!res.ok) {
      derr("Product/location fetch failed:", {
        status: res.status,
        bodyPreview: (json as any)?.__rawText,
        contentType: (json as any)?.__contentType,
        jsonError: (json as any)?.__jsonError,
      });
    } else {
      const rows = Array.isArray((json as any)?.data)
        ? (json as any).data
        : Array.isArray(json)
        ? json
        : [];

      dlog("Product/location rows:", rows.length);

      const matchedRow =
        rows.find((row: any) => {
          const rowSlugNorm = norm(row?.slug);
          const productSlugNorm = norm(row?.product?.slug);
          return (
            (rowSlugNorm && rowSlugNorm === slugFromUrlNorm) ||
            (productSlugNorm && productSlugNorm === slugFromUrlNorm)
          );
        }) || rows[0];

      dlog("Matched row:", {
        found: !!matchedRow,
        matchAgainstSlug: slugFromUrlNorm || "(none)",
        rowSlug: norm(matchedRow?.slug),
        productSlug: norm(matchedRow?.product?.slug),
      });

      if (matchedRow) {
        const product: any = matchedRow.product || {};
        const location: any = matchedRow.location || {};

        // Product Q&A
        for (let i = 1; i <= 6; i++) {
          const q = product[`productquestion${i}`];
          const a = product[`productanswer${i}`];

          if (q && a && String(q).trim() && String(a).trim()) {
            combinedProductFaqs.push({
              id: `product-${matchedRow._id || "row"}-${i}`,
              questionHtml: cleanHtml(String(q)),
              answerHtml: cleanHtml(String(a)),
              source: "product",
            });
          }
        }

        // Location Q&A
        for (let i = 1; i <= 6; i++) {
          const q = location[`locationquestion${i}`];
          const a = location[`locationanswer${i}`];

          if (q && a && String(q).trim() && String(a).trim()) {
            combinedProductFaqs.push({
              id: `location-${matchedRow._id || "row"}-${i}`,
              questionHtml: cleanHtml(String(q)),
              answerHtml: cleanHtml(String(a)),
              source: "location",
            });
          }
        }

        dlog("Product/location FAQs final usable:", combinedProductFaqs.length);
      }
    }
  } catch (err) {
    derr("Product/location fetch exception:", err);
    combinedProductFaqs = [];
  }
}

/* ===== Final list ===== */
const allFaqs: FaqItem[] = [...combinedProductFaqs, ...globalFaqs];

dlog("TOTAL FAQs rendered:", allFaqs.length);
---

<section id="faq" class="faq-section">
  <div class="container">
    <div class="faq-layout">
      <!-- Left: Intro + CTA -->
      <div class="faq-intro">
        <p class="faq-eyebrow">FAQ • Support for your sourcing team</p>
        <h2 class="faq-title">Clear answers, zero friction.</h2>
        <p class="faq-text">
          A quick snapshot of how we handle MOQ, sampling, timelines, and quality
          so your team can move faster with confidence.
        </p>
        <ul class="faq-points">
          <li>Realistic MOQs for brands & exporters</li>
          <li>Structured QA + lab testing support</li>
          <li>Custom fabric development on request</li>
        </ul>

        <div class="faq-cta-inline">
          <a href={telHref} class="btn">Talk to a Fabric Specialist</a>
          <a href={whatsappHref} class="btn secondary" target="_blank" rel="noopener noreferrer">
            Browse Fabric Catalog
          </a>
        </div>
      </div>

      <!-- Right: FAQ List -->
      <div class="faq-list-wrap">
        <div class="faq-list">
          {allFaqs.length > 0 ? (
            allFaqs.map((faq) => (
              <div class="faq-item" data-faq-item>
                <button class="faq-question" type="button" aria-expanded="false">
                  <div class="faq-question-main" set:html={faq.questionHtml}></div>

                  <span class="faq-icon-wrap">
                    <svg class="faq-icon" width="14" height="14" viewBox="0 0 16 16" aria-hidden="true">
                      <path
                        d="M3 8H13M8 3V13"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>

                <div class="faq-answer" hidden>
                  <div class="faq-answer-inner" set:html={faq.answerHtml}></div>
                </div>
              </div>
            ))
          ) : (
            <p>No FAQs available right now. Please check back later.</p>
          )}
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* (your CSS unchanged) */
  .faq-section { padding: 72px 0; background: var(--tp-grey-1); }
  .faq-layout { display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1.2fr); gap: 56px; align-items: flex-start; }
  .faq-intro { display: flex; flex-direction: column; gap: 18px; }
  .faq-eyebrow { font-size: .8rem; letter-spacing: .16em; text-transform: uppercase; color: var(--tp-theme-primary); font-weight: 600; display: inline-block; padding: 6px 12px; background: rgba(44, 76, 151, 0.08); border-radius: 20px; width: fit-content; margin: 0; }
  .faq-title { font-size: clamp(1.9rem, 4vw, 2.2rem); line-height: 1.2; color: var(--tp-text-1); margin: 0; font-family: var(--tp-ff-display); font-weight: 700; }
  .faq-text { margin: 0; font-size: 1.02rem; line-height: 1.7; color: var(--tp-text-2); max-width: 90%; }
  .faq-points { margin: 8px 0 0; padding-left: 0; display: grid; gap: 10px; font-size: .95rem; color: var(--tp-text-2); }
  .faq-points li { display: flex; align-items: center; gap: 10px; list-style: none; }
  .faq-points li::before { content: ""; display: block; width: 6px; height: 6px; border-radius: 50%; background: var(--tp-theme-secondary); }
  .faq-cta-inline { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 18px; }
  .faq-cta-inline .btn { padding: 11px 22px; font-size: .92rem; border-radius: 999px; font-weight: 600; transition: all .3s ease; text-align: center; justify-content: center; }
  .faq-cta-inline .btn.secondary { background: transparent; color: var(--tp-theme-primary); border: 1.5px solid rgba(44, 76, 151, 0.3); }
  .faq-cta-inline .btn.secondary:hover { border-color: var(--tp-theme-primary); background: rgba(44, 76, 151, 0.05); transform: translateY(-1px); }
  .faq-list-wrap { display: flex; justify-content: center; }
  .faq-list { display: flex; flex-direction: column; gap: 14px; width: 100%; max-width: 620px; }
  .faq-item { border-radius: 18px; background: var(--tp-common-white); border: 1px solid var(--tp-grey-2); box-shadow: var(--shadow-1); padding: 0; transition: all .25s ease; overflow: hidden; position: relative; }
  .faq-item::before { content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 0; background: var(--tp-theme-primary); transition: height .25s ease; }
  .faq-item:hover { box-shadow: 0 8px 24px rgba(17, 35, 56, 0.12); border-color: rgba(44, 76, 151, 0.18); }
  .faq-item.active { border-color: var(--tp-theme-primary); box-shadow: 0 8px 26px rgba(44, 76, 151, 0.16); }
  .faq-item.active::before { height: 100%; }
  .faq-question { width: 100%; padding: 16px 20px 16px 24px; cursor: pointer; display: flex; gap: 12px; align-items: center; justify-content: space-between; font-size: .98rem; font-weight: 600; color: var(--tp-text-1); background: none; border: none; text-align: left; font-family: inherit; transition: all .25s ease; }
  .faq-question:hover { color: var(--tp-theme-primary); }
  .faq-question-main { flex: 1; min-width: 0; word-break: break-word; }
  .faq-question-main :where(h1,h2,h3,h4,h5,h6,p,strong,em,span) { margin: 0; font: inherit; color: inherit; }
  .faq-question-main pre, .faq-answer-inner pre { font: inherit; white-space: normal !important; word-break: break-word; margin: 0; }
  .faq-icon-wrap { display: inline-flex; align-items: center; justify-content: center; width: 26px; height: 26px; border-radius: 8px; background: rgba(44, 76, 151, 0.08); color: var(--tp-theme-primary); flex-shrink: 0; transition: all .25s ease; }
  .faq-item.active .faq-icon-wrap { background: var(--tp-theme-primary); color: var(--tp-common-white); }
  .faq-icon { transition: transform .25s ease; }
  .faq-item.active .faq-icon { transform: rotate(45deg); }
  .faq-answer { padding: 0 24px; max-height: 0; overflow: hidden; font-size: .93rem; line-height: 1.65; color: var(--tp-text-2); transition: max-height .3s ease, padding-bottom .3s ease, opacity .3s ease; opacity: 0; }
  .faq-item.active .faq-answer { padding-bottom: 14px; opacity: 1; }
  .faq-answer-inner { padding-top: 2px; }
  .faq-answer-inner :where(p,h1,h2,h3,h4,h5,h6) { margin: 4px 0 0; font-size: .93rem; line-height: 1.65; }
  .faq-answer-inner ul, .faq-answer-inner ol { padding-left: 1.2rem; margin: 6px 0 0; }
  .faq-answer-inner li { margin: 2px 0; }

  @media (max-width: 1024px) {
    .faq-layout { grid-template-columns: 1fr; gap: 40px; }
    .faq-section { padding: 60px 0; }
    .faq-text { max-width: 100%; }
    .faq-list { max-width: 100%; }
  }
  @media (max-width: 600px) {
    .faq-section { padding: 40px 0; }
    .faq-title { font-size: 1.7rem; }
    .faq-question { padding: 14px 16px; font-size: .95rem; }
    .faq-answer { padding: 0 16px; }
    .faq-item.active .faq-answer { padding-bottom: 12px; }
    .faq-cta-inline { flex-direction: column; align-items: stretch; }
    .faq-cta-inline .btn { width: 100%; text-align: center; }
  }
</style>

<script>
  // Client-side accordion logs (browser console)
  document.addEventListener("DOMContentLoaded", function () {
    const faqItems = document.querySelectorAll("[data-faq-item]");
    console.log("[FAQ] Client accordion init. Items:", faqItems.length);

    faqItems.forEach((item) => {
      const questionEl = item.querySelector(".faq-question");
      const answerEl = item.querySelector(".faq-answer");

      if (!(questionEl instanceof HTMLElement) || !(answerEl instanceof HTMLElement)) return;

      questionEl.addEventListener("click", () => {
        const isActive = item.classList.contains("active");

        faqItems.forEach((otherItem) => {
          if (otherItem === item) return;

          const otherQuestionEl = otherItem.querySelector(".faq-question");
          const otherAnswerEl = otherItem.querySelector(".faq-answer");

          if (!(otherQuestionEl instanceof HTMLElement) || !(otherAnswerEl instanceof HTMLElement)) return;

          otherItem.classList.remove("active");
          otherAnswerEl.style.maxHeight = "0px";
          otherAnswerEl.hidden = true;
          otherQuestionEl.setAttribute("aria-expanded", "false");
        });

        if (!isActive) {
          item.classList.add("active");
          answerEl.hidden = false;
          answerEl.style.maxHeight = answerEl.scrollHeight + "px";
          questionEl.setAttribute("aria-expanded", "true");
        } else {
          item.classList.remove("active");
          answerEl.style.maxHeight = "0px";
          questionEl.setAttribute("aria-expanded", "false");

          setTimeout(() => {
            if (!item.classList.contains("active")) answerEl.hidden = true;
          }, 300);
        }
      });
    });
  });
</script>
